<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IELTS Zen">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/480/dna-helix.png">

    <title>IELTS Zen - v33.0 Mobile App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="words.js" onerror="console.log('Local words.js not found')"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        :root { --glass: blur(20px) saturate(180%); }
        body { 
            font-family: 'Outfit', 'Noto Sans SC', sans-serif; 
            color: #334155; overflow: hidden; background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, rgba(224, 231, 255, 0.9) 0, transparent 55%),
                radial-gradient(at 100% 0%, rgba(243, 232, 255, 0.9) 0, transparent 55%),
                radial-gradient(at 50% 100%, rgba(252, 231, 243, 0.9) 0, transparent 60%);
            background-attachment: fixed; background-size: cover;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom); /* Â∫ïÈÉ®ÂÆâÂÖ®Âå∫ */
        }
        
        .glass-panel { background: rgba(255, 255, 255, 0.65); backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass); border: 1px solid rgba(255, 255, 255, 0.4); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); box-shadow: 0 10px 40px -10px rgba(79, 70, 229, 0.1); border: 1px solid rgba(255, 255, 255, 0.6); }
        
        /* ÂØºËà™ÊøÄÊ¥ªÁä∂ÊÄÅ */
        .nav-active { background-color: rgba(255, 255, 255, 0.9); color: #4f46e5; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); font-weight: 700; }
        .mobile-nav-active { color: #4f46e5; font-weight: 800; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* --- 3D ÁøªËΩ¨ --- */
        .flip-container { perspective: 1000px; width: 100%; height: 100%; }
        .flipper { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); transform-style: preserve-3d; }
        .flipper.flipped { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1.5rem; overflow: hidden; background: white; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .front { transform: rotateY(0deg); z-index: 2; }
        .back { transform: rotateY(180deg); z-index: 1; }
        /* ‰∫§‰∫í‰øÆÂ§ç */
        .flipper:not(.flipped) .back { pointer-events: none !important; }
        .flipper:not(.flipped) .front { pointer-events: auto !important; }
        .flipper.flipped .front { pointer-events: none !important; }
        .flipper.flipped .back { pointer-events: auto !important; }

        /* Ê†∑ÂºèÂæÆË∞É */
        .cloze-input { border: none; border-bottom: 2px solid #6366f1; background: rgba(99, 102, 241, 0.05); color: #4f46e5; font-weight: 700; font-size: 1.25rem; text-align: center; padding: 0 4px; margin: 0 4px; outline: none; border-radius: 0; }
        .match-card { background-color: white; color: #475569; border: 1px solid #e2e8f0; transition: all 0.2s; }
        .match-card:active { transform: scale(0.95); background-color: #f1f5f9; }
        .match-card.selected { background-color: #4f46e5 !important; color: white !important; border-color: #4338ca !important; }
        .match-card.wrong { background-color: #f43f5e !important; color: white !important; border-color: #e11d48 !important; animation: shake 0.4s; }
        .pop-out { animation: popOut 0.4s forwards; } @keyframes popOut { to { opacity: 0; transform: scale(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* ÂàóË°®È°πÈÄâ‰∏≠Áä∂ÊÄÅ */
        .lib-item { transition: all 0.2s; border: 2px solid transparent; }
        .lib-item[data-active="true"] { background-color: #eff6ff !important; border-color: #4f46e5 !important; }
        .lib-item[data-active="true"] .lib-icon-box { background-color: #4f46e5 !important; color: white !important; }

        /* ÁßªÂä®Á´ØÁâπÊÆäÈÄÇÈÖç */
        @media (max-width: 768px) {
            #main-container { padding-bottom: 5rem; /* ‰∏∫Â∫ïÈÉ®ÂØºËà™Ê†èÁïôÁ©∫ */ }
            .mobile-hide { display: none !important; }
            .mobile-stack { flex-direction: column; }
            #match-grid { gap: 0.5rem; }
            .match-card { height: 3.5rem; font-size: 0.75rem; padding: 2px; }
        }
        
        /* ÂºπÁ™ó */
        #modal-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); transition: opacity 0.3s; pointer-events: none; opacity: 0; }
        #modal-overlay.active { pointer-events: auto; opacity: 1; }
        #modal-content { transform: scale(0.95); opacity: 0; transition: all 0.3s; }
        #modal-overlay.active #modal-content { transform: scale(1); opacity: 1; }
    </style>
</head>
<body class="flex h-screen w-screen flex-col md:flex-row">

    <aside class="hidden md:flex w-64 h-full glass-panel border-r-0 flex-col flex-shrink-0 z-50">
        <div class="p-8 pb-6">
            <div class="flex items-center gap-2 text-indigo-600 mb-1">
                <div class="p-1.5 bg-indigo-600 rounded-lg shadow-sm"><i data-lucide="zap" class="w-5 h-5 text-white"></i></div>
                <h1 class="text-2xl font-extrabold tracking-tight text-slate-800">IELTS Zen</h1>
            </div>
            <p class="text-[10px] text-slate-500 pl-10 font-medium tracking-wide">v33.0 Mobile</p>
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <button onclick="app.nav('dashboard')" id="desk-nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-white/40 transition-all font-medium"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>Overview</span></button>
            <button onclick="app.nav('study')" id="desk-nav-study" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-white/40 transition-all font-medium"><i data-lucide="layers" class="w-5 h-5"></i><span>Cards</span></button>
            <button onclick="app.nav('sentence')" id="desk-nav-sentence" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-white/40 transition-all font-medium"><i data-lucide="pen-tool" class="w-5 h-5"></i><span>Cloze</span></button>
            <button onclick="app.nav('quiz')" id="desk-nav-quiz" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-white/40 transition-all font-medium"><i data-lucide="trophy" class="w-5 h-5"></i><span>Quiz</span></button>
            <button onclick="app.nav('match')" id="desk-nav-match" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-white/40 transition-all font-medium"><i data-lucide="grid" class="w-5 h-5"></i><span>Match</span></button>
            <button onclick="app.nav('list')" id="desk-nav-list" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-white/40 transition-all font-medium"><i data-lucide="book" class="w-5 h-5"></i><span>List</span></button>
            <button onclick="app.nav('library')" id="desk-nav-library" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-white/40 transition-all font-medium"><i data-lucide="library" class="w-5 h-5"></i><span>Library</span></button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-[#f3f4f6]">
        <header class="h-16 px-6 flex items-center justify-between flex-shrink-0 z-30">
            <h2 id="page-title" class="text-xl md:text-2xl font-bold text-slate-800 tracking-tight">IELTS Zen</h2>
            <button onclick="app.nav('library')" class="md:hidden glass-panel px-3 py-1.5 rounded-full flex items-center gap-2 text-xs font-bold text-indigo-600">
                <i data-lucide="book-open" class="w-3 h-3"></i> <span id="mobile-lib-name">Libs</span>
            </button>
            <div class="hidden md:flex gap-4">
                <div class="glass-panel px-4 py-2 rounded-full flex items-center gap-2 text-sm font-bold text-indigo-600 shadow-sm border border-white/50">
                    <i data-lucide="book-open" class="w-4 h-4"></i><span id="active-lib-name">Default</span>
                </div>
            </div>
        </header>

        <div id="main-container" class="flex-1 overflow-y-auto p-4 md:p-10 pt-0">
            
            <div id="view-dashboard" class="view-section max-w-5xl mx-auto space-y-6 hidden fade-in">
                <div class="w-full h-40 md:h-48 rounded-3xl bg-gradient-to-r from-indigo-500 to-purple-600 shadow-xl flex items-center px-6 md:px-10 relative overflow-hidden text-white mt-2">
                    <div class="z-10"><h1 class="text-2xl md:text-3xl font-bold mb-2">Welcome!</h1><p class="text-indigo-100 max-w-xs text-sm md:text-base mb-4">Master your vocabulary anywhere.</p><button onclick="app.nav('study')" class="bg-white text-indigo-600 px-5 py-2 rounded-lg font-bold text-sm hover:scale-105 transition-transform shadow-lg flex items-center gap-2">Start Review</button></div>
                    <i data-lucide="target" class="absolute -right-6 -bottom-10 w-48 h-48 text-white opacity-10 rotate-12"></i>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="glass-card p-5 rounded-2xl text-center flex items-center justify-between md:block"><div class="text-left md:text-center"><p class="text-slate-500 text-xs uppercase font-bold">Today</p><h3 class="text-2xl font-bold text-slate-800" id="dash-learned-today">0</h3></div><div class="p-3 bg-blue-50 text-blue-500 rounded-xl"><i data-lucide="calendar" class="w-5 h-5"></i></div></div>
                    <div class="glass-card p-5 rounded-2xl text-center flex items-center justify-between md:block"><div class="text-left md:text-center"><p class="text-slate-500 text-xs uppercase font-bold">Best Score</p><h3 class="text-2xl font-bold text-slate-800" id="dash-highscore">0</h3></div><div class="p-3 bg-amber-50 text-amber-500 rounded-xl"><i data-lucide="trophy" class="w-5 h-5"></i></div></div>
                    <div class="glass-card p-5 rounded-2xl text-center flex items-center justify-between md:block"><div class="text-left md:text-center"><p class="text-slate-500 text-xs uppercase font-bold">Total</p><h3 class="text-2xl font-bold text-slate-800" id="dash-total">0</h3></div><div class="p-3 bg-emerald-50 text-emerald-500 rounded-xl"><i data-lucide="database" class="w-5 h-5"></i></div></div>
                </div>
            </div>

            <div id="view-study" class="view-section h-full flex flex-col items-center justify-center max-w-xl mx-auto -mt-4 hidden">
                <div class="w-full mb-4 glass-panel p-3 rounded-2xl flex items-center justify-between">
                    <div class="flex items-center gap-3"><div class="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg"><i data-lucide="flag" class="w-4 h-4"></i></div><div><p class="text-[10px] text-slate-500 font-bold uppercase">Daily Goal</p><p class="text-xs font-bold text-slate-800"><span id="daily-current">0</span> / <span id="daily-target">20</span></p></div></div>
                    <button onclick="app.setDailyGoal()" class="text-xs text-indigo-500 hover:text-indigo-700 font-bold px-2">Edit</button>
                </div>
                <div class="flip-container w-full aspect-[3/4] md:aspect-[4/5] max-h-[550px]">
                    <div class="flipper" id="card-inner">
                        <div class="front cursor-pointer" onclick="app.flipCard()">
                            <div class="h-1.5 w-full bg-slate-100 absolute top-0 left-0"><div class="h-full bg-indigo-500 w-0 transition-all duration-300" id="progress-bar"></div></div>
                            <div class="flex-1 flex flex-col items-center justify-center">
                                <span class="inline-block px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-[10px] font-bold tracking-wider mb-6 uppercase">Flashcard</span>
                                <h1 id="card-word" class="text-4xl md:text-6xl font-extrabold text-slate-800 mb-6 tracking-tight text-center px-4 break-words">Loading</h1>
                                <button onclick="app.speak(event)" class="group flex items-center gap-2 px-4 py-2 rounded-full bg-slate-50 text-slate-500 border border-slate-200 action-btn"><i data-lucide="volume-2" class="w-4 h-4"></i><span id="card-phonetic" class="font-mono text-xs"></span></button>
                                <p class="absolute bottom-6 text-xs text-slate-400 animate-pulse">Tap to flip</p>
                            </div>
                        </div>
                        <div class="back text-left cursor-pointer" onclick="app.flipCard()">
                            <div class="h-1.5 w-full bg-slate-100 absolute top-0 left-0"><div class="h-full bg-indigo-500 w-0 transition-all duration-300" id="progress-bar-back"></div></div>
                            <div class="flex-1 overflow-y-auto no-scrollbar p-6 pt-8">
                                <div class="flex justify-between items-start mb-4 border-b border-slate-100 pb-3">
                                    <div><h2 id="detail-word" class="text-2xl font-bold text-slate-800 break-words">...</h2><p id="detail-trans" class="text-lg text-indigo-600 font-bold mt-1">...</p></div>
                                    <button class="p-2 rounded-full bg-slate-50 text-slate-400 action-btn"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                                </div>
                                <div class="space-y-4">
                                    <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Definition</p><p id="detail-def" class="text-slate-700 text-sm leading-relaxed">...</p></div>
                                    <div class="bg-indigo-50/50 p-3 rounded-xl border-l-4 border-indigo-400">
                                        <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Example</p>
                                        <p id="detail-ex" class="text-slate-700 italic text-sm leading-relaxed">...</p>
                                        <p id="detail-ex-trans" class="text-slate-500 text-xs mt-2 pt-2 border-t border-indigo-200/50">...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border-t border-slate-100 bg-slate-50/80 flex gap-3 cursor-auto action-btn" onclick="event.stopPropagation()">
                                <button onclick="app.prevCard()" class="flex-1 py-3 rounded-xl font-bold text-sm bg-white border border-slate-200 text-slate-600 shadow-sm hover:bg-slate-50 flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                                <button onclick="app.nextCard()" class="flex-[2] py-3 rounded-xl font-bold text-sm bg-indigo-600 text-white shadow-lg flex items-center justify-center gap-2">Next <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-sentence" class="view-section hidden max-w-3xl mx-auto h-full flex flex-col justify-center">
                <div class="glass-card p-6 md:p-12 rounded-3xl relative text-center mt-4">
                    <span class="inline-block px-3 py-1 bg-emerald-50 text-emerald-600 rounded-full text-[10px] font-bold tracking-wider mb-6 uppercase">Sentence Craft</span>
                    <div id="sent-container" class="mb-8 text-lg md:text-2xl font-medium text-slate-700 leading-loose">Loading...</div>
                    <div class="text-xs text-indigo-500 font-bold mb-8 bg-indigo-50 inline-block px-3 py-2 rounded-lg border border-indigo-100 max-w-full">Trans: <span id="sent-trans" class="text-slate-700 font-normal">...</span></div>
                    <div class="flex flex-col gap-3">
                        <button onclick="app.checkSentence()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">Check</button>
                        <div class="flex gap-3">
                            <button onclick="app.showAnswer()" class="flex-1 py-3 bg-amber-500 text-white rounded-xl font-bold shadow-sm">Answer</button>
                            <button onclick="app.nextSentence()" class="flex-1 py-3 bg-white text-slate-500 border border-slate-200 rounded-xl font-bold">Skip</button>
                        </div>
                    </div>
                    <div id="sent-feedback" class="mt-4 font-bold h-6 text-sm"></div>
                </div>
            </div>

            <div id="view-match" class="view-section hidden h-full max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-4 px-1 mt-2">
                    <div class="flex items-center gap-2">
                        <button onclick="app.prepareMatchGame()" class="text-xs bg-white border border-indigo-200 text-rose-500 px-3 py-1.5 rounded-lg font-bold shadow-sm">Stop</button>
                        <div class="flex items-center gap-1 bg-white px-2 py-1 rounded-lg border border-slate-200"><i data-lucide="timer" class="w-3 h-3 text-slate-400"></i><input type="number" id="match-duration" value="60" class="w-6 text-xs font-bold text-center text-slate-700 outline-none bg-transparent" onchange="app.saveState()" min="10" max="300"></div>
                    </div>
                    <div class="flex flex-col flex-1 mx-3"><div class="w-full h-1.5 bg-slate-200 rounded-full overflow-hidden"><div id="game-timer-bar" class="h-full bg-orange-500 w-full transition-all duration-1000 ease-linear"></div></div></div>
                    <div id="combo-display" class="text-lg font-black text-orange-500 opacity-0">x<span id="combo-count">0</span></div>
                </div>
                <div id="match-grid" class="grid grid-cols-4 gap-2 pb-4 select-none h-auto relative"></div>
                <div class="mt-2 glass-card p-3 rounded-xl">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">History</h4>
                    <div id="match-history-list" class="space-y-1 max-h-20 overflow-y-auto text-[10px] text-slate-600 no-scrollbar"><p class="text-center">No records.</p></div>
                </div>
            </div>

            <div id="view-quiz" class="view-section hidden h-full flex flex-col justify-center"><div class="glass-card w-full p-6 rounded-3xl relative"><div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100"><div><span class="text-xs font-bold text-slate-400 uppercase">Progress</span><p class="text-lg font-bold text-indigo-600"><span id="quiz-idx">1</span> / <span id="quiz-total">20</span></p></div><div class="text-right"><span class="text-xs font-bold text-slate-400 uppercase">Score</span><p class="text-lg font-bold text-emerald-600" id="quiz-score">0</p></div></div><div id="quiz-container"><h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">Ready?</h2><button onclick="app.startQuizRun()" class="w-full p-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">Start</button></div><div id="quiz-history" class="mt-6 pt-4 border-t border-slate-100 hidden"><h4 class="text-xs font-bold text-slate-400 uppercase mb-2">History</h4><div id="history-list" class="space-y-1 max-h-24 overflow-y-auto text-xs text-slate-600"></div></div></div></div>
            <div id="view-list" class="view-section hidden h-full flex flex-col"><div class="glass-card rounded-3xl overflow-hidden flex-1 flex flex-col mt-2"><div class="overflow-y-auto flex-1"><table class="w-full text-left text-xs md:text-sm"><thead class="bg-indigo-50/50 text-slate-500 font-bold border-b border-slate-200 sticky top-0 bg-white/90 backdrop-blur"><tr><th class="p-3">Word</th><th class="p-3">Trans</th></tr></thead><tbody id="list-body" class="divide-y divide-slate-100"></tbody></table></div><div class="p-3 border-t border-slate-100 bg-white/50 backdrop-blur flex justify-between items-center text-xs"><div class="flex gap-2"><button onclick="app.firstPage()" class="px-2 py-1 bg-white border rounded">|&lt;</button><button onclick="app.prevPage()" class="px-2 py-1 bg-white border rounded">&lt;</button></div><span class="font-bold text-slate-500" id="page-info">1</span><div class="flex gap-2"><button onclick="app.nextPage()" class="px-2 py-1 bg-white border rounded">&gt;</button><button onclick="app.lastPage()" class="px-2 py-1 bg-white border rounded">&gt;|</button></div></div></div></div>
            <div id="view-library" class="view-section max-w-3xl mx-auto hidden"><div class="glass-card p-6 rounded-3xl mt-4"><div class="text-center mb-6"><h2 class="text-2xl font-bold text-slate-800 mb-1">Libraries</h2><p class="text-xs text-slate-500">Manage data.</p></div><div class="border-2 border-dashed border-slate-300 rounded-2xl p-4 hover:border-indigo-500 transition-all cursor-pointer relative mb-6 text-center"><input type="file" id="file-upload" class="absolute inset-0 opacity-0" accept=".js,.json,.txt" onchange="app.handleFileUpload(event)"><div class="pointer-events-none"><p class="font-bold text-indigo-600 text-sm flex items-center justify-center gap-2"><i data-lucide="upload-cloud" class="w-4 h-4"></i> Add Library</p></div></div><div id="library-list" class="space-y-2"></div></div></div>
        </div>

        <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 z-[100] flex justify-around items-center pb-safe pt-2 h-16">
            <button onclick="app.nav('dashboard')" id="mob-nav-dashboard" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-indigo-600 transition-colors"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="text-[10px] font-medium">Home</span></button>
            <button onclick="app.nav('study')" id="mob-nav-study" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-indigo-600 transition-colors"><i data-lucide="layers" class="w-5 h-5"></i><span class="text-[10px] font-medium">Cards</span></button>
            <button onclick="app.nav('match')" id="mob-nav-match" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-indigo-600 transition-colors"><i data-lucide="grid" class="w-5 h-5"></i><span class="text-[10px] font-medium">Match</span></button>
            <button onclick="app.nav('sentence')" id="mob-nav-sentence" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-indigo-600 transition-colors"><i data-lucide="pen-tool" class="w-5 h-5"></i><span class="text-[10px] font-medium">Cloze</span></button>
            <button onclick="app.nav('quiz')" id="mob-nav-quiz" class="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-indigo-600 transition-colors"><i data-lucide="trophy" class="w-5 h-5"></i><span class="text-[10px] font-medium">Quiz</span></button>
        </nav>
        
        <div id="modal-overlay" class="fixed inset-0 z-[110] flex items-center justify-center p-4" onclick="app.closeModal(event)"><div id="modal-content" class="bg-white rounded-3xl shadow-2xl w-full max-w-sm mx-auto overflow-hidden relative" onclick="event.stopPropagation()"><button onclick="app.closeModal()" class="absolute top-4 right-4 p-2 z-10 text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button><div class="p-6"><div class="text-center mb-4"><h2 id="modal-word" class="text-3xl font-extrabold text-slate-800 mb-1">Word</h2><span id="modal-phonetic" class="text-slate-500 font-mono text-xs bg-slate-50 px-2 py-0.5 rounded-full"></span></div><div class="space-y-3"><div class="text-center"><p class="text-[10px] font-bold text-indigo-500 uppercase">Definition</p><p id="modal-def" class="text-slate-700 text-sm font-medium">...</p></div><div class="text-center"><p class="text-[10px] font-bold text-emerald-500 uppercase">Translation</p><p id="modal-trans" class="text-slate-700 text-sm">...</p></div></div></div><div class="bg-slate-50 p-3 text-center border-t border-slate-100"><button onclick="app.speakWordFromModal()" class="text-indigo-600 font-bold text-xs flex items-center justify-center gap-2"><i data-lucide="volume-2" class="w-4 h-4"></i> Pronounce</button></div></div></div>
    </main>

    <script>
        const app = {
            data: [], libraries: [], activeLibId: null,
            state: { view: 'dashboard', index: 0, listPage: 1, dailyGoal: 20, todayLearned: 0, lastDate: null },
            quiz: { active: false, timer: null, time: 0, score: 0, current: 0, total: 20, history: [] },
            sentence: { current: null, answer: "" },
            match: { timer: null, timeLeft: 60, totalTime: 60, combo: 0, selected: null, history: [] },
            
            init() {
                const storedLibs = localStorage.getItem('ielts_libraries');
                const storedActiveId = localStorage.getItem('ielts_active_lib_id');
                if (storedLibs) { this.libraries = JSON.parse(storedLibs); this.activeLibId = storedActiveId; } 
                else if (window.IELTS_DB) { this.createLibrary('Default (words.js)', window.IELTS_DB); } 
                else { this.createDemoLib(); }
                this.loadActiveLibrary();
                const s = JSON.parse(localStorage.getItem('ielts_user_state')||'{}');
                const t = new Date().toDateString();
                this.state.dailyGoal = s.dailyGoal||20; this.quiz.history = s.quizHistory||[]; this.match.history = s.matchHistory||[]; this.match.totalTime = s.matchDuration || 60;
                this.state.todayLearned = (s.lastDate===t)?(s.todayLearned||0):0; this.state.lastDate = t;
                const dInput = document.getElementById('match-duration'); if(dInput) dInput.value = this.match.totalTime;
                this.updateStats(); this.nav('dashboard'); this.renderIcons();
            },

            // --- Multi-Library Logic ---
            createLibrary(name, data) {
                const newLib = { id: String(Date.now()), name: name, data: data, date: new Date().toLocaleDateString() };
                this.libraries.push(newLib); this.activeLibId = newLib.id;
                this.saveLibraries(); this.loadActiveLibrary();
            },
            createDemoLib() { this.createLibrary('Demo', [{w:"Welcome", t:"Ê¨¢Ëøé", p:"", d:"Upload data.", e:"Welcome.", e_t:"Ê¨¢Ëøé„ÄÇ"}]); },
            saveLibraries() { localStorage.setItem('ielts_libraries', JSON.stringify(this.libraries)); localStorage.setItem('ielts_active_lib_id', this.activeLibId); },
            loadActiveLibrary() {
                const lib = this.libraries.find(l => String(l.id) === String(this.activeLibId));
                if (lib) {
                    this.data = lib.data;
                    const nameEl = document.getElementById('active-lib-name'); if(nameEl) nameEl.innerText = lib.name;
                    const mobName = document.getElementById('mobile-lib-name'); if(mobName) mobName.innerText = lib.name.substring(0,6)+'...';
                } else if (this.libraries.length > 0) {
                    this.activeLibId = String(this.libraries[0].id);
                    this.loadActiveLibrary();
                }
                this.updateStats();
            },
            switchLibrary(id) {
                this.activeLibId = String(id);
                this.saveLibraries();
                this.loadActiveLibrary();
                this.renderLibraryList();
            },
            deleteLibrary(id, event) {
                event.stopPropagation();
                if(!confirm("Delete?")) return;
                this.libraries = this.libraries.filter(l => String(l.id) !== String(id));
                if (this.libraries.length === 0) this.createDemoLib();
                else if (String(this.activeLibId) === String(id)) this.activeLibId = String(this.libraries[0].id);
                this.saveLibraries(); this.loadActiveLibrary(); this.renderLibraryList();
            },
            renderLibraryList() {
                const list = document.getElementById('library-list');
                list.innerHTML = this.libraries.map(lib => {
                    const isActive = String(lib.id) === String(this.activeLibId);
                    return `<div class="lib-item flex justify-between items-center p-4 rounded-xl cursor-pointer bg-white border-slate-100" data-id="${lib.id}" data-active="${isActive}" onclick="app.switchLibrary('${lib.id}')"><div class="flex items-center gap-3"><div class="p-2 rounded-lg bg-slate-100 text-slate-500 lib-icon-box transition-colors">${isActive ? '<i data-lucide="check-circle-2" class="w-5 h-5"></i>' : '<i data-lucide="book" class="w-5 h-5"></i>'}</div><div><p class="text-sm font-bold text-slate-700 lib-name-text transition-colors">${lib.name}</p><p class="text-xs text-slate-400">${lib.data.length} words</p></div></div>${this.libraries.length > 1 ? `<button onclick="app.deleteLibrary('${lib.id}', event)" class="p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}</div>`;
                }).join('');
                lucide.createIcons();
            },

            // --- Navigation ---
            nav(view) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                
                // Desktop Nav
                document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('nav-active', 'bg-white', 'text-indigo-600'); el.classList.add('text-slate-500'); });
                const deskBtn = document.getElementById(`desk-nav-${view}`);
                if(deskBtn) { deskBtn.classList.remove('text-slate-500'); deskBtn.classList.add('nav-active', 'bg-white', 'text-indigo-600'); }
                
                // Mobile Nav
                document.querySelectorAll('[id^="mob-nav-"]').forEach(el => { el.classList.remove('mobile-nav-active', 'text-indigo-600'); el.classList.add('text-slate-400'); });
                const mobBtn = document.getElementById(`mob-nav-${view}`);
                if(mobBtn) { mobBtn.classList.remove('text-slate-400'); mobBtn.classList.add('mobile-nav-active', 'text-indigo-600'); }

                if(view==='study') this.loadCard(); if(view==='list') this.renderList(); if(view==='sentence') this.nextSentence(); if(view==='quiz') this.resetQuizUI(); if(view==='match') { this.renderMatchHistory(); this.prepareMatchGame(); } if(view==='library') this.renderLibraryList();
            },
            saveState() { 
                const durationInput = document.getElementById('match-duration');
                if(durationInput) this.match.totalTime = parseInt(durationInput.value) || 60;
                localStorage.setItem('ielts_user_state', JSON.stringify({ dailyGoal:this.state.dailyGoal, todayLearned:this.state.todayLearned, lastDate:this.state.lastDate, quizHistory:this.quiz.history, matchHistory:this.match.history, matchDuration:this.match.totalTime })); 
                this.updateStats(); 
            },

            // --- Study ---
            loadCard() {
                if (!this.data || this.data.length === 0) { this.loadActiveLibrary(); if (!this.data || this.data.length === 0) return; }
                const w = this.data[this.state.index % this.data.length];
                document.getElementById('card-inner').classList.remove('flipped'); 
                document.getElementById('card-word').innerText = w.w; document.getElementById('card-phonetic').innerText = w.p||""; document.getElementById('detail-word').innerText = w.w; document.getElementById('detail-trans').innerText = w.t||""; document.getElementById('detail-def').innerText = w.d||"No definition"; document.getElementById('detail-ex').innerText = w.e?`"${w.e}"`:"No example"; document.getElementById('detail-ex-trans').innerText = w.e_t||"";
                const pct = `${((this.state.index%this.data.length)/this.data.length)*100}%`; document.getElementById('progress-bar').style.width = pct; document.getElementById('progress-bar-back').style.width = pct; document.getElementById('daily-current').innerText = this.state.todayLearned; document.getElementById('daily-target').innerText = this.state.dailyGoal;
            },
            flipCard() { document.getElementById('card-inner').classList.toggle('flipped'); },
            nextCard() { this.state.todayLearned++; if(this.state.todayLearned===this.state.dailyGoal) confetti(); this.saveState(); this.state.index++; this.loadCard(); },
            prevCard() { if(this.state.index>0) this.state.index--; this.loadCard(); }, 

            // --- Sentence ---
            nextSentence() {
                let w, i=0; do{ w=this.data[Math.floor(Math.random()*this.data.length)]; i++; }while((!w.e||w.e.length<10)&&i<200);
                if(!w.e) return document.getElementById('sent-container').innerText="No examples.";
                this.sentence.answer = w.w.toLowerCase();
                const regex = new RegExp(`\\b${w.w}\\w*`, 'gi');
                let found=false;
                let html = w.e.replace(regex, m => { found=true; return `<input type="text" id="inline-input" class="cloze-input" style="width:${Math.max(60, m.length*12)}px" autocomplete="off">`; });
                if(!found) return this.nextSentence(); 
                document.getElementById('sent-container').innerHTML = html; document.getElementById('sent-trans').innerText = w.e_t || w.t; document.getElementById('sent-feedback').innerText = "";
                setTimeout(()=>{const inp=document.getElementById('inline-input'); if(inp){inp.focus(); inp.onkeydown=e=>{if(e.key==='Enter')this.checkSentence()}}},100);
            },
            checkSentence() {
                const inp = document.getElementById('inline-input'); if(!inp) return;
                const v = inp.value.trim().toLowerCase();
                if(v && (v===this.sentence.answer || this.sentence.answer.startsWith(v) || v.startsWith(this.sentence.answer))) { inp.classList.add('correct'); document.getElementById('sent-feedback').innerText="Correct!"; document.getElementById('sent-feedback').className="mt-4 font-bold h-6 text-emerald-500"; confetti({particleCount:30,origin:{y:0.6}}); setTimeout(()=>this.nextSentence(),1500); } 
                else { inp.classList.add('wrong'); setTimeout(()=>inp.classList.remove('wrong'),500); document.getElementById('sent-feedback').innerText="Try again"; document.getElementById('sent-feedback').className="mt-4 font-bold h-6 text-rose-500"; }
            },
            showAnswer() { const inp=document.getElementById('inline-input'); if(!inp)return; inp.value=this.sentence.answer; inp.classList.add('revealed'); inp.focus(); },

            // --- Match ---
            prepareMatchGame() {
                clearInterval(this.match.timer);
                document.getElementById('match-grid').innerHTML = `<div class="col-span-4 flex flex-col items-center justify-center h-48 animate-in fade-in zoom-in duration-300"><div class="p-3 rounded-full bg-indigo-100 text-indigo-600 mb-3"><i data-lucide="gamepad-2" class="w-6 h-6"></i></div><h3 class="text-lg font-bold text-slate-700 mb-1">Ready?</h3><button onclick="app.startMatchGame()" class="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-500 transition-all flex items-center gap-2 text-sm"><i data-lucide="play" class="w-4 h-4"></i> Start</button></div>`;
                lucide.createIcons();
            },
            startMatchGame() {
                clearInterval(this.match.timer); 
                const durationInput = document.getElementById('match-duration');
                this.match.totalTime = parseInt(durationInput.value) || 60;
                this.match.timeLeft = this.match.totalTime;
                this.match.combo = 0; this.match.selected = null;
                document.getElementById('combo-display').classList.add('opacity-0');
                const grid = document.getElementById('match-grid'); grid.innerHTML = '';
                const subset = []; for(let k=0; k<8; k++) subset.push(this.data[Math.floor(Math.random()*this.data.length)]);
                let cards = []; subset.forEach((w, i) => { cards.push({id: i, txt: w.w, type: 'en'}); cards.push({id: i, txt: w.t, type: 'cn'}); });
                cards.sort(() => Math.random() - 0.5);
                cards.forEach(c => { const el = document.createElement('div'); el.className = "p-2 rounded-xl flex items-center justify-center text-center font-bold cursor-pointer h-16 md:h-24 text-xs md:text-sm overflow-hidden match-card"; el.innerText = c.txt; el.onclick = () => this.handleMatchClick(el, c); grid.appendChild(el); });
                this.match.timer = setInterval(() => { this.match.timeLeft--; const pct = (this.match.timeLeft / this.match.totalTime) * 100; document.getElementById('game-timer-bar').style.width = `${pct}%`; if(this.match.timeLeft <= 0) this.endMatchGame(false); }, 1000);
            },
            handleMatchClick(el, c) {
                if(el.classList.contains('opacity-0')) return; 
                if(!this.match.selected) { this.match.selected = {el, c}; el.classList.add('selected'); } 
                else {
                    if(this.match.selected.c.id === c.id && this.match.selected.c.type !== c.type) { el.classList.add('pop-out'); this.match.selected.el.classList.add('pop-out'); this.match.combo++; document.getElementById('combo-count').innerText=this.match.combo; document.getElementById('combo-display').classList.remove('opacity-0'); const remaining = document.querySelectorAll('.match-card:not(.pop-out)').length; if (remaining <= 2) setTimeout(() => this.endMatchGame(true), 500); } 
                    else { el.classList.add('wrong'); this.match.selected.el.classList.add('wrong'); const saved1 = this.match.selected.el; const saved2 = el; setTimeout(() => { saved1.classList.remove('wrong','selected'); saved2.classList.remove('wrong','selected'); }, 500); }
                    this.match.selected = null;
                }
            },
            endMatchGame(win) { clearInterval(this.match.timer); if (win) { confetti({ particleCount: 150, spread: 80 }); alert(`üèÜ Win! Time left: ${this.match.timeLeft}s`); } else { alert("‚è∞ Time's Up!"); } const record = { date: new Date().toLocaleTimeString(), result: win ? "Win" : "Fail", pairs: this.match.combo, time: `${this.match.totalTime - this.match.timeLeft}s` }; this.match.history.unshift(record); if(this.match.history.length > 10) this.match.history.pop(); this.saveState(); this.renderMatchHistory(); this.prepareMatchGame(); },
            renderMatchHistory() { const list = document.getElementById('match-history-list'); if(!this.match.history.length) return; list.innerHTML = this.match.history.map(h => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100"><span class="text-xs text-slate-400">${h.date}</span><span class="font-bold ${h.result==='Win'?'text-emerald-500':'text-rose-500'} text-xs">${h.result}</span><span class="text-xs text-indigo-600 font-bold">${h.pairs}</span><span class="font-mono text-xs text-slate-500">${h.time}</span></div>`).join(''); },

            // --- Common ---
            renderList(){ const s=(this.state.listPage-1)*100; const max=Math.ceil(this.data.length/100); document.getElementById('list-body').innerHTML=this.data.slice(s,s+100).map((w,i)=>`<tr class="hover:bg-indigo-50/40 cursor-pointer" onclick="app.openModal(${s+i})"><td class="p-3 font-bold text-slate-700">${w.w}</td><td class="p-3 text-slate-500">${w.t}</td></tr>`).join(''); document.getElementById('page-info').innerText=`${this.state.listPage}/${max}`; },
            nextPage(){ if(this.state.listPage<Math.ceil(this.data.length/100)){this.state.listPage++; this.renderList();} }, prevPage(){ if(this.state.listPage>1){this.state.listPage--; this.renderList();} },
            firstPage(){ this.state.listPage=1; this.renderList(); }, lastPage(){ this.state.listPage=Math.ceil(this.data.length/100); this.renderList(); },
            openModal(i){ const w=this.data[i]; document.getElementById('modal-word').innerText=w.w; document.getElementById('modal-phonetic').innerText=w.p||""; document.getElementById('modal-def').innerText=w.d||"-"; document.getElementById('modal-trans').innerText=w.t||""; document.getElementById('modal-ex').innerText=w.e||"-"; document.getElementById('modal-ext').innerText=w.e_t||""; document.getElementById('modal-overlay').classList.add('active'); },
            closeModal(e){ if(!e||e.target.id==='modal-overlay'||e.target.tagName==='BUTTON') document.getElementById('modal-overlay').classList.remove('active'); },
            speakWordFromModal(){ const t=document.getElementById('modal-word').innerText; const u=new SpeechSynthesisUtterance(t); u.lang='en-GB'; window.speechSynthesis.speak(u); },
            handleFileUpload(e){ 
                const f=e.target.files[0]; if(!f)return; const r=new FileReader(); 
                r.onload=ev=>{ 
                    const t=ev.target.result; let parsed = [];
                    try{ 
                        if(f.name.endsWith('.js')) parsed=JSON.parse(t.substring(t.indexOf('['),t.lastIndexOf(']')+1)); 
                        else parsed=t.split('\n').map(l=>{let m=l.trim().match(/^(\S+)\s+(\[.*?\])?\s*(.*)$/); return m?{w:m[1],p:m[2]||"",t:m[3]||"",d:"",e:"",e_t:""}:null}).filter(i=>i); 
                        this.createLibrary(f.name, parsed); alert("Library Added!"); this.nav('library'); 
                    }catch{alert("Format Error");} 
                }; r.readAsText(f); 
            },
            resetData(){ if(confirm("Clear ALL data?")){localStorage.clear(); location.reload();} },
            renderIcons(){ lucide.createIcons(); }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>